<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Test Case Generator</title>
    <script src="https://connect-cdn.atl-paas.net/all.js" async></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            padding: 16px;
            background: #fff;
        }

        .container {
            max-width: 100%;
        }

        h2 {
            color: #172b4d;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .subtitle {
            color: #5e6c84;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .config-section {
            background: #f4f5f7;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .config-section h3 {
            font-size: 13px;
            color: #172b4d;
            margin-bottom: 10px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .config-section h3:after {
            content: ' ‚ñº';
            font-size: 9px;
        }

        .config-section h3.collapsed:after {
            content: ' ‚ñ∂';
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #5e6c84;
            margin-bottom: 4px;
        }

        input, select {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #dfe1e6;
            border-radius: 3px;
            font-size: 13px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #0052cc;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-right: 8px;
            margin-top: 8px;
        }

        .btn-primary {
            background: #0052cc;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0747a6;
        }

        .btn-secondary {
            background: #f4f5f7;
            color: #42526e;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #ebecf0;
        }

        .btn-success {
            background: #00875a;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #006644;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .testcase-output {
            background: #f4f5f7;
            border-radius: 4px;
            padding: 12px;
            margin: 16px 0;
            min-height: 150px;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.5;
            color: #172b4d;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .testcase-output.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 16px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0052cc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 10px 12px;
            border-radius: 3px;
            margin-bottom: 12px;
            font-size: 12px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #e3fcef;
            color: #006644;
            border-left: 3px solid #00875a;
        }

        .alert-error {
            background: #ffebe6;
            color: #bf2600;
            border-left: 3px solid #de350b;
        }

        .alert-info {
            background: #deebff;
            color: #0747a6;
            border-left: 3px solid #0052cc;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ü§ñ AI Test Case Generator</h2>
        <p class="subtitle">Generate test cases using Google Gemini AI</p>

        <div class="alert alert-info" id="issueInfo"></div>
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>

        <div class="config-section">
            <h3 onclick="toggleConfig()">‚öôÔ∏è Configuration</h3>
            <div id="configContent" class="collapsible-content">
                <div class="form-group">
                    <label for="jiraApiToken">Jira API Token</label>
                    <input type="password" id="jiraApiToken" placeholder="Your Jira API token">
                </div>
                <div class="form-group">
                    <label for="jiraEmail">Jira Email</label>
                    <input type="email" id="jiraEmail" placeholder="your-email@example.com">
                </div>
                <div class="form-group">
                    <label for="geminiApiKey">Google Gemini API Key</label>
                    <input type="password" id="geminiApiKey" placeholder="Your Gemini API key">
                </div>
                <div class="form-group">
                    <label for="testrailApiKey">TestRail API Key</label>
                    <input type="password" id="testrailApiKey" placeholder="Your TestRail API key">
                </div>
                <div class="form-group">
                    <label for="testrailEmail">TestRail Email</label>
                    <input type="email" id="testrailEmail" placeholder="your-email@example.com">
                </div>
                <div class="form-group">
                    <label for="testrailProjectId">TestRail Project ID</label>
                    <input type="text" id="testrailProjectId" placeholder="e.g., 1">
                </div>
                <div class="form-group">
                    <label for="testrailSuiteId">TestRail Suite ID (Optional)</label>
                    <input type="text" id="testrailSuiteId" placeholder="e.g., 1">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="generateTestCase()">
                ‚ú® Generate Test Case
            </button>
            <button class="btn btn-secondary" onclick="refreshIssueData()">
                üîÑ Refresh Issue Data
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Generating test case with AI...</p>
        </div>

        <div class="testcase-output" id="testcaseOutput"></div>

        <div class="button-group" id="actionButtons" style="display: none;">
            <button class="btn btn-secondary" onclick="regenerateTestCase()">
                üîÑ Regenerate
            </button>
            <button class="btn btn-success" onclick="confirmAndCreate()">
                ‚úì Confirm & Create in TestRail
            </button>
        </div>
    </div>

    <script>
        console.log('Script loaded');

        // Configuration
        const JIRA_BASE_URL = 'https://teamfox-sandbox.atlassian.net';
        const TESTRAIL_BASE_URL = 'https://teamfoxsandbox.testrail.io';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
        
        // Use CORS proxy for Jira requests (GitHub Pages can't directly call Jira API)
        const CORS_PROXY = 'https://corsproxy.io/?';
        const USE_CORS_PROXY = true; // Set to false if hosting on own server

        let currentIssue = null;
        let generatedTestCase = null;

        // ScriptRunner passes issue context via URL hash or query params
        function getIssueKeyFromScriptRunner() {
            console.log('--- Attempting URL-based issue detection ---');
            
            // Method 1: Direct query parameter (most common)
            const urlParams = new URLSearchParams(window.location.search);
            console.log('All URL params:', Array.from(urlParams.entries()));
            
            // Try to get issue data from URL params (passed by ScriptRunner)
            const issueKey = urlParams.get('issueKey');
            const issueSummary = urlParams.get('issueSummary');
            const issueDescription = urlParams.get('issueDescription');
            const issueType = urlParams.get('issueType');
            const issuePriority = urlParams.get('issuePriority');
            
            console.log('URL params - issueKey:', issueKey);
            console.log('URL params - issueSummary:', issueSummary);
            console.log('URL params - issueDescription:', issueDescription);
            
            // If we have issue data from URL, create a full issue object
            if (issueKey && (issueSummary || issueDescription)) {
                console.log('Building issue object from URL params');
                currentIssue = {
                    key: issueKey,
                    fields: {
                        summary: decodeURIComponent(issueSummary || ''),
                        description: decodeURIComponent(issueDescription || ''),
                        issuetype: { name: decodeURIComponent(issueType || 'N/A') },
                        priority: { name: decodeURIComponent(issuePriority || 'N/A') }
                    }
                };
                console.log('Issue object created from URL:', JSON.stringify(currentIssue));
                return issueKey;
            }
            
            if (issueKey) return issueKey;
            
            const issueKey2 = urlParams.get('issue.key');
            console.log('urlParams.get("issue.key"):', issueKey2);
            if (issueKey2) return issueKey2;
            
            const issueKey3 = urlParams.get('issue');
            console.log('urlParams.get("issue"):', issueKey3);
            if (issueKey3) return issueKey3;

            // Method 2: Check URL hash
            const hash = window.location.hash;
            console.log('URL hash:', hash);
            if (hash) {
                const hashMatch = hash.match(/issueKey=([A-Z]+-\d+)/i);
                console.log('Hash match result:', hashMatch);
                if (hashMatch) return hashMatch[1];
            }

            // Method 3: Check entire URL for issue pattern
            const fullUrl = window.location.href;
            console.log('Full URL:', fullUrl);
            const urlMatch = fullUrl.match(/[?&]issueKey=([A-Z]+-\d+)/i);
            console.log('URL match result:', urlMatch);
            if (urlMatch) return urlMatch[1];

            // Method 4: Look for any issue key pattern in URL
            const anyMatch = fullUrl.match(/([A-Z]+-\d+)/);
            console.log('Any issue pattern match:', anyMatch);
            if (anyMatch) return anyMatch[1];

            console.log('--- No issue key found via URL ---');
            return null;
        }

        // Initialize - Wait for AP to be fully ready
        function initialize() {
            console.log('=== INITIALIZATION START ===');
            console.log('Current URL:', window.location.href);
            
            // Load saved configuration first
            loadConfig();
            
            // Try URL detection first
            const urlIssueKey = getIssueKeyFromScriptRunner();
            console.log('Issue key from URL detection:', urlIssueKey);
            
            if (urlIssueKey && !urlIssueKey.includes('${')) {
                // Found valid issue key in URL (not a variable)
                currentIssue = { key: urlIssueKey };
                
                // Try to fetch full issue details if credentials are available
                const jiraEmail = document.getElementById('jiraEmail').value;
                const jiraToken = document.getElementById('jiraApiToken').value;
                if (jiraEmail && jiraToken) {
                    fetchIssueDetails(urlIssueKey);
                } else {
                    showInfo('üìã Issue: ' + urlIssueKey + '\n‚ö†Ô∏è Configure Jira API credentials to load full details');
                }
                console.log('=== Issue key set from URL ===');
                return;
            }
            
            // Wait for AP to be ready
            console.log('Waiting for AP to be ready...');
            waitForAP();
        }

        function waitForAP() {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds total
            
            const checkAP = setInterval(function() {
                attempts++;
                console.log('Checking for AP... Attempt:', attempts);
                
                if (typeof AP !== 'undefined' && AP.context && typeof AP.context.getContext === 'function') {
                    clearInterval(checkAP);
                    console.log('AP is ready!');
                    getIssueFromAP();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkAP);
                    console.error('AP failed to load after', attempts, 'attempts');
                    showError('Could not connect to Jira. Please refresh the page.');
                }
            }, 100); // Check every 100ms
        }

        function getIssueFromAP() {
            try {
                AP.context.getContext(function(context) {
                    console.log('AP Context received:', JSON.stringify(context));
                    
                    if (context && context.jira && context.jira.issue && context.jira.issue.key) {
                        const issueKey = context.jira.issue.key;
                        console.log('Issue key from AP context:', issueKey);
                        currentIssue = { key: issueKey };
                        
                        // Now fetch full issue details from Jira
                        fetchIssueDetails(issueKey);
                    } else {
                        console.error('No issue found in AP context');
                        showError('Could not detect issue. Context: ' + JSON.stringify(context));
                    }
                });
            } catch (error) {
                console.error('Error getting AP context:', error);
                showError('Error getting issue context: ' + error.message);
            }
        }

        async function fetchIssueDetails(issueKey) {
            const jiraEmail = document.getElementById('jiraEmail').value;
            const jiraToken = document.getElementById('jiraApiToken').value;

            console.log('=== FETCHING ISSUE DETAILS ===');
            console.log('Issue Key:', issueKey);
            console.log('Jira Email:', jiraEmail);
            console.log('Has Jira Token:', !!jiraToken);
            console.log('Using CORS Proxy:', USE_CORS_PROXY);

            // If credentials are provided, fetch full issue details
            if (jiraEmail && jiraToken) {
                try {
                    showInfo('üìã Loading issue details...');
                    
                    const auth = btoa(jiraEmail + ':' + jiraToken);
                    let url = JIRA_BASE_URL + '/rest/api/3/issue/' + issueKey;
                    
                    // Add CORS proxy if needed
                    if (USE_CORS_PROXY) {
                        url = CORS_PROXY + encodeURIComponent(url);
                        console.log('Using CORS proxy URL:', url);
                    }
                    
                    console.log('Fetching from URL:', url);
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': 'Basic ' + auth,
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    console.log('Jira API Response status:', response.status);

                    if (response.ok) {
                        const issueData = await response.json();
                        currentIssue = issueData;
                        console.log('=== FULL ISSUE DATA FETCHED ===');
                        console.log(JSON.stringify(issueData, null, 2));
                        
                        const fields = issueData.fields || {};
                        const summary = fields.summary || 'N/A';
                        const issueType = fields.issuetype?.name || 'N/A';
                        
                        // Extract description
                        let descriptionPreview = 'No description';
                        if (fields.description) {
                            if (typeof fields.description === 'string') {
                                descriptionPreview = fields.description.substring(0, 100);
                            } else if (fields.description.content) {
                                const fullDesc = extractTextFromADF(fields.description);
                                descriptionPreview = fullDesc.substring(0, 100);
                                console.log('Full description extracted:', fullDesc);
                            }
                        }
                        
                        showInfo('üìã Issue: ' + issueKey + '\nüìù ' + summary + '\nüè∑Ô∏è Type: ' + issueType + '\nüìÑ ' + descriptionPreview + '...');
                        console.log('Issue data successfully loaded and stored in currentIssue');
                    } else {
                        const errorText = await response.text();
                        console.error('Jira API Error:', errorText);
                        console.warn('Could not fetch full issue details, using key only');
                        showInfo('üìã Issue: ' + issueKey + '\n‚ö†Ô∏è Error loading details: ' + response.status);
                    }
                } catch (error) {
                    console.error('Error fetching issue details:', error);
                    showError('Could not load issue details: ' + error.message + '\n\nNote: CORS restrictions may prevent direct API calls from GitHub Pages. Consider using ScriptRunner\'s inline script approach or hosting on your own server.');
                }
            } else {
                console.warn('Jira credentials not configured');
                showInfo('üìã Issue: ' + issueKey + '\n‚ö†Ô∏è Configure Jira API credentials to load summary and description');
            }
        }

        async function refreshIssueData() {
            if (!currentIssue || !currentIssue.key) {
                showError('No issue key available');
                return;
            }
            
            const jiraEmail = document.getElementById('jiraEmail').value;
            const jiraToken = document.getElementById('jiraApiToken').value;
            
            if (!jiraEmail || !jiraToken) {
                showError('Please configure Jira API credentials first');
                return;
            }
            
            await fetchIssueDetails(currentIssue.key);
        }

        function showIssueKeyInput() {
            const infoDiv = document.getElementById('issueInfo');
            infoDiv.innerHTML = `
                ‚ö†Ô∏è Issue key not auto-detected. Please enter manually:<br>
                <input type="text" id="manualIssueKey" placeholder="e.g., PROJ-123" style="margin-top: 8px; padding: 6px; border: 2px solid #0052cc; border-radius: 3px;">
                <button onclick="setManualIssueKey()" style="margin-left: 8px; padding: 6px 12px; background: #0052cc; color: white; border: none; border-radius: 3px; cursor: pointer;">Set Issue</button>
            `;
            infoDiv.classList.add('show');
        }

        function setManualIssueKey() {
            const issueKey = document.getElementById('manualIssueKey').value.trim();
            if (issueKey) {
                setIssueKey(issueKey);
            } else {
                showError('Please enter a valid issue key');
            }
        }

        function loadConfig() {
            ['jiraEmail', 'testrailEmail', 'testrailProjectId', 'testrailSuiteId'].forEach(key => {
                try {
                    const value = sessionStorage.getItem(key);
                    if (value) {
                        const element = document.getElementById(key);
                        if (element) element.value = value;
                    }
                } catch (e) {
                    console.log('Cannot load from sessionStorage:', e);
                }
            });
        }

        function saveConfig() {
            const config = {
                jiraEmail: document.getElementById('jiraEmail').value,
                testrailEmail: document.getElementById('testrailEmail').value,
                testrailProjectId: document.getElementById('testrailProjectId').value,
                testrailSuiteId: document.getElementById('testrailSuiteId').value
            };
            
            Object.keys(config).forEach(key => {
                if (config[key]) {
                    try {
                        sessionStorage.setItem(key, config[key]);
                    } catch (e) {
                        console.log('Cannot save to sessionStorage:', e);
                    }
                }
            });
        }

        function toggleConfig() {
            const content = document.getElementById('configContent');
            const header = content.previousElementSibling;
            content.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        function validateConfig() {
            const required = ['geminiApiKey', 'testrailEmail', 'testrailApiKey', 'testrailProjectId'];
            
            for (const field of required) {
                const value = document.getElementById(field).value;
                if (!value) {
                    showError('Please configure: ' + field.replace(/([A-Z])/g, ' $1').trim());
                    return false;
                }
            }
            
            // Check if we have Jira credentials for fetching issue data
            const jiraEmail = document.getElementById('jiraEmail').value;
            const jiraToken = document.getElementById('jiraApiToken').value;
            
            if (!jiraEmail || !jiraToken) {
                showError('Please configure Jira API credentials (email and token) to fetch issue details for better test case generation.');
                return false;
            }
            
            saveConfig();
            return true;
        }

        async function generateTestCase() {
            console.log('Generating test case...');
            
            if (!validateConfig()) return;

            if (!currentIssue || !currentIssue.key) {
                showError('No issue key available. Please open this from a Jira issue.');
                return;
            }

            showLoading(true);
            hideError();
            hideSuccess();
            document.getElementById('actionButtons').style.display = 'none';

            try {
                const geminiApiKey = document.getElementById('geminiApiKey').value;
                const issueKey = currentIssue.key;

                const prompt = `You are a QA engineer. Generate a comprehensive test case for Jira issue ${issueKey}.

Please create a detailed test case with the following structure:
- Title: A clear, concise title for the test case
- Preconditions: Any setup required before testing
- Test Steps: Numbered steps to execute the test (use numbers like 1., 2., 3.)
- Expected Results: What should happen for each step
- Test Data: Any specific data needed
- Priority: High/Medium/Low

Format the output as structured text that can be easily parsed. Make it detailed and professional.`;

                console.log('Calling Gemini API...');

                const response = await fetch(GEMINI_API_URL + '?key=' + geminiApiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Failed to generate test case');
                }

                const data = await response.json();
                console.log('Gemini response received');

                generatedTestCase = data.candidates[0].content.parts[0].text;

                displayTestCase(generatedTestCase);
                document.getElementById('actionButtons').style.display = 'flex';
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate test case: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayTestCase(testCase) {
            const output = document.getElementById('testcaseOutput');
            output.textContent = testCase;
            output.classList.add('show');
        }

        async function regenerateTestCase() {
            await generateTestCase();
        }

        async function confirmAndCreate() {
            if (!generatedTestCase) {
                showError('No test case to create');
                return;
            }

            showLoading(true);
            hideError();
            hideSuccess();

            try {
                const testrailEmail = document.getElementById('testrailEmail').value;
                const testrailApiKey = document.getElementById('testrailApiKey').value;
                const projectId = document.getElementById('testrailProjectId').value;
                const suiteId = document.getElementById('testrailSuiteId').value;

                const testCaseData = parseTestCase(generatedTestCase);

                console.log('Creating test case in TestRail...');

                const auth = btoa(testrailEmail + ':' + testrailApiKey);
                
                let endpoint = TESTRAIL_BASE_URL + '/index.php?/api/v2/add_case/' + projectId;
                if (suiteId) {
                    endpoint += '&suite_id=' + suiteId;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + auth,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testCaseData)
                });

                console.log('TestRail response status:', response.status);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create test case in TestRail');
                }

                const result = await response.json();
                const testCaseUrl = TESTRAIL_BASE_URL + '/index.php?/cases/view/' + result.id;

                const successDiv = document.getElementById('successAlert');
                successDiv.innerHTML = '‚úÖ Test case successfully created in TestRail!<br><br>üîó <a href="' + testCaseUrl + '" target="_blank" style="color: #006644; font-weight: bold;">View Test Case</a>';
                successDiv.classList.add('show');

            } catch (error) {
                console.error('Error:', error);
                showError('Failed to create test case in TestRail: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function parseTestCase(testCase) {
            const titleMatch = testCase.match(/Title[:\s]+(.+)/i);
            const title = titleMatch ? titleMatch[1].trim() : 'Test Case for ' + (currentIssue?.key || 'Issue');

            const preconditions = extractSection(testCase, 'Preconditions?');
            const steps = extractSection(testCase, 'Test Steps?');
            const expected = extractSection(testCase, 'Expected Results?');

            let priority = 2;
            if (testCase.toLowerCase().includes('priority: high')) priority = 1;
            if (testCase.toLowerCase().includes('priority: low')) priority = 3;

            return {
                title: title,
                custom_preconds: preconditions,
                custom_steps: steps,
                custom_expected: expected,
                priority_id: priority,
                refs: currentIssue?.key || ''
            };
        }

        function extractSection(text, sectionName) {
            const regex = new RegExp(sectionName + '[:\\s]+([\\s\\S]*?)(?=\\n\\n|$|(?:Title|Preconditions?|Test Steps?|Expected Results?|Test Data|Priority)[:\\s])', 'i');
            const match = text.match(regex);
            return match ? match[1].trim() : '';
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
            document.getElementById('generateBtn').disabled = show;
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorAlert').classList.remove('show');
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.classList.add('show');
        }

        function hideSuccess() {
            document.getElementById('successAlert').classList.remove('show');
        }

        function showInfo(message) {
            const alert = document.getElementById('issueInfo');
            alert.textContent = message;
            alert.classList.add('show');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        console.log('Script execution complete');
    </script>
</body>
</html>
